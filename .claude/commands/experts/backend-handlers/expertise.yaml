# Backend Handlers Expertise
# HTTP layer - parse/validate/respond only

overview:
  layer: "handlers"
  path: "project/backend/internal/handlers/"
  imports: "Everything above + net/http"
  contains: "HTTP handlers, middleware, routes"

pattern:
  - "Parse request body"
  - "Validate input"
  - "Call use case"
  - "Return JSON response"

handlers:
  chat:
    file: "handler_chat.go"
    struct: "ChatHandler"
    endpoint: "POST /api/v1/chat"
    request: "{ sessionId?, tenantId?, message }"
    response: "{ sessionId, response, latencyMs }"

  session:
    file: "handler_session.go"
    struct: "SessionHandler"
    endpoint: "GET /api/v1/session/{id}"
    response: "{ id, status, messages[], startedAt, lastActivityAt }"
    behavior: "Checks SessionTTL on read - marks session as closed if expired"

  catalog:
    file: "handler_catalog.go"
    struct: "CatalogHandler"
    endpoints:
      - "GET /api/v1/tenants/{slug}/products"
      - "GET /api/v1/tenants/{slug}/products/{id}"
    query_params: ["category", "brand", "minPrice", "maxPrice", "search", "limit", "offset"]

  pipeline:
    file: "handler_pipeline.go"
    struct: "PipelineHandler"
    endpoint: "POST /api/v1/pipeline"
    request: "{ sessionId?, query }"
    response: "{ sessionId, formation: { mode, grid, widgets }, agent1Ms, agent2Ms, totalMs }"

  debug:
    file: "handler_debug.go"
    struct: "DebugHandler"
    endpoints:
      - "GET /debug/session/ - list all sessions (HTML)"
      - "GET /debug/session/{id} - session detail (HTML or JSON with ?format=json)"
      - "GET /debug/api - all sessions JSON"
      - "GET /debug/api?session={id} - specific session JSON"
      - "POST /debug/seed - create session with mock products for testing without LLM"
    types: ["MetricsStore", "PipelineMetrics", "AgentMetrics", "FormationInfo"]
    agent_metrics_cache_fields: ["CacheCreationInputTokens", "CacheReadInputTokens", "CacheHitRate"]

  navigation:
    file: "handler_navigation.go"
    struct: "NavigationHandler"
    endpoints:
      - "POST /api/v1/navigation/expand - Expand widget to detail view"
      - "POST /api/v1/navigation/back - Navigate back from detail view"
    request_expand: "{ sessionId, entityType, entityId }"
    response: "{ success, formation, viewMode, focused, stackSize, canGoBack }"

  trace:
    file: "handler_trace.go"
    struct: "TraceHandler"
    endpoints:
      - "GET /debug/traces/ - list all traces (HTML table with status, timing, cost, session kill buttons)"
      - "GET /debug/traces/{id} - trace detail (HTML with agent breakdown, tool input/output, deltas)"
      - "GET /debug/traces/?format=json - all traces JSON"
      - "GET /debug/traces/{id}?format=json - single trace JSON"
      - "POST /debug/kill-session - kill a session (delete all data, redirect to traces)"

  health:
    file: "handler_health.go"
    struct: "HealthHandler"
    endpoints: ["GET /health", "GET /ready"]

middleware:
  cors:
    file: "middleware_cors.go"
    function: "CORSMiddleware(handler)"
  tenant:
    file: "middleware_tenant.go"
    struct: "TenantMiddleware"
    purpose: "Resolve tenant slug â†’ UUID"

helpers:
  response:
    file: "response.go"
    functions: ["writeJSON(w, status, data)"]
  routes:
    file: "routes.go"
    functions: ["SetupRoutes()", "SetupNavigationRoutes()", "SetupCatalogRoutes()"]

api_summary:
  - "POST /api/v1/chat"
  - "GET /api/v1/session/{id}"
  - "GET /api/v1/tenants/{slug}/products"
  - "GET /api/v1/tenants/{slug}/products/{id}"
  - "POST /api/v1/pipeline"
  - "POST /api/v1/navigation/expand"
  - "POST /api/v1/navigation/back"
  - "GET /debug/session/"
  - "POST /debug/seed"
  - "GET /debug/traces/"
  - "GET /debug/traces/{id}"
  - "POST /debug/kill-session"
  - "GET /health"
  - "GET /ready"

naming: "handler_{name}.go"
