# Backend Adapters Expertise
# Port implementations - external integrations

overview:
  layer: "adapters"
  path: "project/backend/internal/adapters/"
  imports: "domain/, ports/, external libraries"
  contains: "Port implementations"

adapters:
  anthropic:
    directory: "anthropic/"
    files:
      - "anthropic_client.go - LLMPort implementation: Chat, ChatWithTools, ChatWithToolsCached, ChatWithUsage"
      - "cache_types.go - Prompt caching types: cacheControl, contentBlockWithCache, contentBlockFullCache, anthropicToolWithCache, anthropicCachedRequest, anthropicCachedResponse"
    implements: "LLMPort"
    status: "implemented"
    api: "POST https://api.anthropic.com/v1/messages"
    env:
      - "ANTHROPIC_API_KEY"
      - "LLM_MODEL (default: claude-haiku-4-5-20251001)"
    pricing:
      haiku: "$1/$5 per 1M tokens (input/output)"
      sonnet: "$3/$15 per 1M tokens"
    prompt_caching:
      method: "ChatWithToolsCached"
      cache_points: ["last tool (cache_control)", "system prompt block (cache_control)", "second-to-last message (cache_control)"]
      types_file: "cache_types.go"
      helpers: ["markMessageCacheControl(msg) — uses contentBlockFullCache to preserve all fields (id, name, input)", "convertToAnthropicMessage(msg)"]

  postgres:
    directory: "postgres/"
    status: "implemented"
    implements: ["CachePort", "EventPort", "CatalogPort", "StatePort"]
    files:
      - "postgres_client.go - Connection pool (pgxpool)"
      - "postgres_cache.go - CachePort"
      - "postgres_events.go - EventPort"
      - "postgres_catalog.go - CatalogPort with product merging"
      - "postgres_state.go - StatePort with JSONB"
      - "migrations.go - Chat tables"
      - "catalog_migrations.go - Catalog schema"
      - "state_migrations.go - State tables"
      - "catalog_seed.go - Seed data"
      - "catalog_search_test.go - CatalogPort search tests"
      - "postgres_state_test.go - StatePort integration tests"
    schemas:
      public: ["chat_users", "chat_sessions", "chat_messages", "chat_events", "chat_session_state", "chat_session_deltas"]
      catalog: ["tenants", "categories", "master_products", "products"]
    state_columns:
      chat_session_state: ["id", "session_id", "current_data", "current_meta", "current_template", "view_mode", "view_focused", "view_stack", "conversation_history", "step", "created_at", "updated_at"]
      chat_session_deltas: ["id", "session_id", "step", "trigger", "source", "actor_id", "delta_type", "path", "action", "result", "template", "turn_id", "created_at"]
    add_delta_auto_increment: "Step assigned via COALESCE(MAX(step),0)+1 — no manual step management needed"
    env: "DATABASE_URL=postgresql://user:pass@host/db?sslmode=require"

  json_store:
    directory: "json_store/"
    file: "json_product_store.go"
    implements: "SearchPort"
    status: "stub"

  memory:
    directory: "memory/"
    file: "memory_cache.go"
    implements: "CachePort"
    status: "deprecated (replaced by postgres)"

gotchas:
  postgres:
    - "FK: chat_session_state.session_id → chat_sessions.id"
    - "FK: chat_session_deltas.session_id → chat_sessions.id"
    - "FK: catalog.products.tenant_id → catalog.tenants.id"
    - "ProductFilter conditions are AND-combined"
    - "Search splits multi-word queries into words with OR matching (each word ILIKE in name/brand)"
  anthropic:
    - "API version: 2023-06-01"
    - "Response includes usage.input_tokens, usage.output_tokens"
    - "Prompt caching is GA (Dec 2024) — no beta header needed, just cache_control in request"
    - "Prompt caching needs minimum 4096 tokens for Haiku (20 padding tools provide ~5500 tokens)"
    - "ConversationHistory persisted in postgres via conversation_history JSONB column"
    - "Go encoding/json.Marshal sorts map keys deterministically — cache-stable tool definitions"

naming: "{tech}_{purpose}.go"
