# Backend Domain Expertise
# Entities, types, errors - zero dependencies

overview:
  layer: "domain"
  path: "project/backend/internal/domain/"
  imports: "Nothing from internal/ - only stdlib"
  contains: "Entities, types, domain errors"

entities:
  ui_primitives:
    atom_entity:
      file: "atom_entity.go"
      types: ["AtomType", "AtomSubtype", "AtomSlot", "Atom"]
      atom_types: ["text", "number", "image", "icon", "video", "audio"]
      atom_subtypes:
        text: ["string", "date", "datetime", "url", "email", "phone"]
        number: ["int", "float", "currency", "percent", "rating"]
        image: ["url", "base64"]
        icon: ["name", "emoji", "svg"]
      atom_slots: ["hero", "badge", "title", "primary", "price", "secondary", "gallery", "stock", "description", "tags", "specs"]
      atom_fields: ["Type", "Subtype", "Display", "Value", "Slot", "Meta"]
      legacy_mapping: "LegacyTypeMapping maps old types (price, rating, badge) to new type+subtype+display"
    display_entity:
      file: "display_entity.go"
      types: ["AtomDisplay", "DisplayStyle"]
      displays:
        text: ["h1", "h2", "h3", "h4", "body-lg", "body", "body-sm", "caption", "badge", "badge-success", "badge-error", "badge-warning", "tag", "tag-active"]
        number: ["price", "price-lg", "price-old", "price-discount", "rating", "rating-text", "rating-compact", "percent", "progress"]
        image: ["image", "image-cover", "avatar", "avatar-sm", "avatar-lg", "thumbnail", "gallery"]
        icon: ["icon", "icon-sm", "icon-lg"]
        interactive: ["button-primary", "button-secondary", "button-outline", "button-ghost", "input"]
        layout: ["divider", "spacer"]
      display_styles: ["product-hero", "product-compact", "product-detail", "service-card", "service-detail"]
      helpers: ["DisplayStyles map", "GetDisplayForSlot()"]
    widget_entity:
      file: "widget_entity.go"
      types: ["WidgetType", "WidgetSize", "Widget"]
      templates: ["ProductCard"]
      widget_fields: ["ID", "Type", "Template", "Size", "Priority", "Atoms", "Children", "Meta", "EntityRef"]
    formation_entity:
      file: "formation_entity.go"
      types: ["FormationType", "Formation"]

  chat:
    message_entity:
      file: "message_entity.go"
      types: ["MessageRole", "Message"]
      fields: ["ID", "SessionID", "Role", "Content", "Widgets", "Formation", "TokensUsed", "ModelUsed", "LatencyMs", "SentAt", "ReceivedAt", "Timestamp"]
    session_entity:
      file: "session_entity.go"
      types: ["SessionStatus", "Session"]
      constants: ["SessionTTL = 5 minutes"]
      fields: ["ID", "UserID", "TenantID", "Status", "Messages", "Metadata", "StartedAt", "EndedAt", "LastActivityAt", "CreatedAt", "UpdatedAt"]
    user_entity:
      file: "user_entity.go"
      types: ["ChatUser"]
    event_entity:
      file: "event_entity.go"
      types: ["EventType", "ChatEvent"]
      event_types: ["chat_opened", "message_sent", "message_received", "chat_closed", "widget_clicked", "session_timeout"]

  catalog:
    entity_type:
      file: "entity_type.go"
      types: ["EntityType"]
      entity_types: ["product", "service"]
    product_entity:
      file: "product_entity.go"
      types: ["Product"]
      fields: ["ID", "TenantID", "MasterProductID", "Name", "Description", "Price", "PriceFormatted", "Currency", "Images", "Rating", "StockQuantity", "Brand", "Category", "Tags", "Attributes"]
    service_entity:
      file: "service_entity.go"
      types: ["Service"]
      fields: ["ID", "TenantID", "Name", "Description", "Price", "PriceFormatted", "Currency", "Duration", "Images", "Rating", "Category", "Provider", "Availability", "Attributes"]
    tenant_entity:
      file: "tenant_entity.go"
      types: ["TenantType", "Tenant"]
      tenant_types: ["brand", "retailer", "reseller"]
    category_entity:
      file: "category_entity.go"
      types: ["Category"]
    master_product_entity:
      file: "master_product_entity.go"
      types: ["MasterProduct"]

  pipeline:
    tool_entity:
      file: "tool_entity.go"
      types: ["ToolDefinition", "ToolCall", "ToolResult", "LLMMessage", "LLMResponse", "LLMUsage"]
      helpers: ["LLMUsage.CalculateCost()", "LLMPricing"]
      llm_usage_fields: ["InputTokens", "OutputTokens", "TotalTokens", "Model", "CostUSD", "CacheCreationInputTokens", "CacheReadInputTokens"]
      calculate_cost: "Accounts for cache pricing: write ×1.25, read ×0.1 of base input price"
      llm_pricing_models: ["claude-haiku-4-5-20251001", "claude-sonnet-4-5-20251014", "claude-opus-4-5-20251101", "claude-3-5-sonnet-20241022", "claude-3-haiku-20240307"]
    template_entity:
      file: "template_entity.go"
      types: ["AtomTemplate", "WidgetTemplate", "GridConfig", "FormationTemplate", "FormationWithData"]
    state_entity:
      file: "state_entity.go"
      types: ["TriggerType", "ActionType", "Action", "ResultMeta", "Delta", "DeltaInfo", "StateMeta", "StateData", "StateCurrent", "SessionState", "DeltaSource", "DeltaType", "ViewMode", "EntityRef", "ViewSnapshot", "ViewState"]
      trigger_types: ["USER_QUERY", "WIDGET_ACTION", "SYSTEM"]
      action_types: ["SEARCH", "FILTER", "SORT", "LAYOUT", "ROLLBACK"]
      delta_sources: ["user", "llm", "system"]
      delta_types: ["add", "remove", "update", "push", "pop", "rollback"]
      view_modes: ["grid", "detail", "list", "carousel"]
      delta_fields: ["Step", "TurnID", "Trigger", "Source", "ActorID", "DeltaType", "Path", "Action", "Result", "Template", "CreatedAt"]
      delta_info: "Lightweight metadata for creating deltas via zone-write; ToDelta() converts to full Delta with CreatedAt"
      state_data_fields: ["Products", "Services"]
      state_meta_fields: ["Count", "ProductCount", "ServiceCount", "Fields", "Aliases"]
      session_state_fields: ["ID", "SessionID", "Current", "View", "ViewStack", "ConversationHistory", "Step", "CreatedAt", "UpdatedAt"]
      conversation_history: "[]LLMMessage - LLM conversation history for prompt caching, append-only"
    preset_entity:
      file: "preset_entity.go"
      types: ["FieldConfig", "SlotConfig", "Preset", "PresetName"]
      preset_names: ["product_grid", "product_card", "product_compact", "product_detail", "service_card", "service_list", "service_detail"]
      field_config: ["Name", "Slot", "AtomType", "Subtype", "Display", "Priority", "Required"]
      preset_fields: ["Name", "EntityType", "Template", "Slots", "Fields", "DefaultMode", "DefaultSize", "Displays"]

  errors:
    file: "domain_errors.go"
    errors: ["ErrSessionNotFound", "ErrProductNotFound", "ErrInvalidQuery", "ErrLLMUnavailable", "ErrTenantNotFound", "ErrCategoryNotFound", "ErrRateLimitExceeded"]

gotchas:
  - "Price stored in kopecks (int), not rubles (float)"
  - "sessionID and tenantID must be valid UUID format"
  - "ErrSessionNotFound returned when state doesn't exist"
  - "Service is parallel to Product for service-based businesses"
  - "Preset defines field→slot→atomType→display mappings for rendering"
  - "SessionTTL (5 min) used for sliding expiration - session becomes closed after inactivity"
  - "Atom model: Type (6 types) + Subtype (data format) + Display (visual format)"
  - "Display can be set by preset, style alias, or explicitly by agent"
  - "Legacy atom types (price, badge, rating) mapped via LegacyTypeMapping"

naming: "{entity}_entity.go"
