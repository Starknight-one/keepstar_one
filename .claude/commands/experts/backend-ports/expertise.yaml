# Backend Ports Expertise
# Interfaces (contracts) - imports only domain/

overview:
  layer: "ports"
  path: "project/backend/internal/ports/"
  imports: "Only domain/"
  contains: "Interfaces for external dependencies"

interfaces:
  llm_port:
    file: "llm_port.go"
    interface: "LLMPort"
    methods:
      - "Chat(ctx, message) (string, error)"
      - "ChatWithTools(ctx, systemPrompt, messages []LLMMessage, tools []ToolDefinition) (*LLMResponse, error)"
      - "ChatWithToolsCached(ctx, systemPrompt, messages []LLMMessage, tools []ToolDefinition, cacheConfig *CacheConfig) (*LLMResponse, error)"
      - "ChatWithUsage(ctx, systemPrompt, userMessage) (*ChatResponse, error)"
    types:
      - "ChatResponse: { Text string, Usage LLMUsage }"
      - "CacheConfig: { CacheTools bool, CacheSystem bool, CacheConversation bool, ToolChoice string }"
    cache_config_tool_choice:
      description: "ToolChoice controls tool_choice parameter: 'auto' (default), 'any' (force tool use), or 'tool:name' (force specific tool)"
      used_by: "Agent2 sets ToolChoice='any' to force render tool call"

  cache_port:
    file: "cache_port.go"
    interface: "CachePort"
    methods:
      - "GetSession(ctx, id) (*Session, error)"
      - "SaveSession(ctx, session) error"
      - "DeleteSession(ctx, id) error — removes session and all related data (state, deltas, traces)"
      - "CacheProducts(ctx, sessionID, products) error"
      - "GetCachedProducts(ctx, sessionID) ([]Product, error)"

  event_port:
    file: "event_port.go"
    interface: "EventPort"
    methods:
      - "TrackEvent(ctx, event) error"
      - "GetSessionEvents(ctx, sessionID) ([]ChatEvent, error)"

  catalog_port:
    file: "catalog_port.go"
    interface: "CatalogPort"
    methods:
      - "GetTenantBySlug(ctx, slug) (*Tenant, error)"
      - "GetCategories(ctx) ([]Category, error)"
      - "GetMasterProduct(ctx, id) (*MasterProduct, error)"
      - "ListProducts(ctx, tenantID, filter) ([]Product, int, error)"
      - "GetProduct(ctx, tenantID, productID) (*Product, error)"
      - "VectorSearch(ctx, tenantID, embedding []float32, limit) ([]Product, error) — semantic similarity via pgvector"
      - "SeedEmbedding(ctx, masterProductID, embedding []float32) error — saves embedding for a master product"
      - "GetMasterProductsWithoutEmbedding(ctx) ([]MasterProduct, error) — returns master products that need embeddings"
    types:
      - "ProductFilter: CategoryID, CategoryName, Brand, MinPrice, MaxPrice, Search, SortField, SortOrder, Limit, Offset, Attributes map[string]string"

  embedding_port:
    file: "embedding_port.go"
    interface: "EmbeddingPort"
    methods:
      - "Embed(ctx, texts []string) ([][]float32, error) — generates vector embeddings for text"

  state_port:
    file: "state_port.go"
    interface: "StatePort"
    methods:
      - "CreateState(ctx, sessionID) (*SessionState, error)"
      - "GetState(ctx, sessionID) (*SessionState, error)"
      - "UpdateState(ctx, state) error"
      - "AddDelta(ctx, sessionID, delta) (int, error) — step auto-assigned via MAX(step)+1"
      - "GetDeltas(ctx, sessionID) ([]Delta, error)"
      - "GetDeltasSince(ctx, sessionID, fromStep) ([]Delta, error)"
      - "GetDeltasUntil(ctx, sessionID, toStep) ([]Delta, error)"
      - "UpdateData(ctx, sessionID, data, meta, info) (int, error) — zone write: updates data zone + creates delta atomically"
      - "UpdateTemplate(ctx, sessionID, template, info) (int, error) — zone write: updates template zone + creates delta atomically"
      - "UpdateView(ctx, sessionID, view, stack, info) (int, error) — zone write: updates view zone + creates delta atomically"
      - "AppendConversation(ctx, sessionID, messages) error — append-only, no delta (LLM cache)"
      - "PushView(ctx, sessionID, snapshot) error"
      - "PopView(ctx, sessionID) (*ViewSnapshot, error)"
      - "GetViewStack(ctx, sessionID) ([]ViewSnapshot, error)"

  trace_port:
    file: "trace_port.go"
    interface: "TracePort"
    methods:
      - "Record(ctx, trace *PipelineTrace) error — saves trace to DB and prints to console"
      - "List(ctx, limit) ([]*PipelineTrace, error) — recent traces, newest first"
      - "Get(ctx, traceID) (*PipelineTrace, error) — single trace by ID"

gotchas:
  - "CatalogPort.ListProducts(tenantID) requires UUID, not slug"
  - "Use GetTenantBySlug(slug) first to get tenant UUID"
  - "StatePort.GetState returns ErrSessionNotFound if no state"
  - "AddDelta auto-assigns step (MAX(step)+1), Delta.Step input is ignored"
  - "ChatWithToolsCached falls back to ChatWithTools if cacheConfig is nil"
  - "Zone writes (UpdateData/UpdateTemplate/UpdateView) atomically update their zone column and create a delta"
  - "AppendConversation does NOT create a delta — it is append-only for LLM cache continuity"
  - "ProductFilter.CategoryName uses ILIKE matching (agent passes name, not UUID)"
  - "ProductFilter.Attributes filters against JSONB attributes with ILIKE values"
  - "VectorSearch requires embeddings to be seeded first via SeedEmbedding"
  - "EmbeddingPort.Embed accepts a batch of texts and returns parallel [][]float32 vectors"

naming: "{name}_port.go"
