# Backend Implementation Expertise
# Keepstar - Go Hexagonal Architecture

overview:
  description: "Go REST API with hexagonal architecture for AI-powered chat widget"
  architecture: "Hexagonal (Ports & Adapters)"
  language: "Go 1.21+"
  port: 8080
  ai_provider: "Anthropic Claude"
  model: "claude-haiku-4-5-20251001"
  database: "Neon PostgreSQL"

project_structure:
  root: "project/backend/"
  entry: "cmd/server/main.go"

  layers:
    domain: "internal/domain/"
    ports: "internal/ports/"
    adapters: "internal/adapters/"
    usecases: "internal/usecases/"
    handlers: "internal/handlers/"
    prompts: "internal/prompts/"
    logger: "internal/logger/"
    config: "internal/config/"

  data: "data/products.json"

layer_rules:
  description: "Dependency direction: handlers → usecases → ports ← adapters, all depend on domain"
  domain:
    imports: "Nothing from internal/"
    contains: "Entities, types, domain errors"
  ports:
    imports: "Only domain/"
    contains: "Interfaces (contracts)"
  usecases:
    imports: "domain/, ports/"
    contains: "Business logic, 1 file = 1 use case"
  adapters:
    imports: "domain/, ports/, external libraries"
    contains: "Port implementations"
  handlers:
    imports: "Everything above + http libraries"
    contains: "HTTP layer, only parse/validate/respond"
  prompts:
    imports: "domain/ (for types)"
    contains: "LLM prompts, separate from logic"

core_implementation:
  main:
    file: "cmd/server/main.go"
    purpose: "Application bootstrap"
    pattern: |
      - Load .env via godotenv
      - Load config
      - Initialize PostgreSQL client (if DATABASE_URL set)
      - Run migrations
      - Initialize adapters (anthropic, postgres)
      - Initialize usecases (sendMessage)
      - Initialize handlers
      - Setup routes
      - Apply CORS middleware
      - Start server with graceful shutdown

  ports:
    llm_port:
      file: "internal/ports/llm_port.go"
      interface: "LLMPort"
      methods:
        - "Chat(ctx context.Context, message string) (string, error)"

    search_port:
      file: "internal/ports/search_port.go"
      interface: "SearchPort"
      status: "stub"

    cache_port:
      file: "internal/ports/cache_port.go"
      interface: "CachePort"
      status: "implemented"
      methods:
        - "GetSession(ctx, id) (*Session, error)"
        - "SaveSession(ctx, session) error"
        - "CacheProducts(ctx, sessionID, products) error"
        - "GetCachedProducts(ctx, sessionID) ([]Product, error)"

    event_port:
      file: "internal/ports/event_port.go"
      interface: "EventPort"
      status: "implemented"
      methods:
        - "TrackEvent(ctx, event) error"
        - "GetSessionEvents(ctx, sessionID) ([]ChatEvent, error)"

  adapters:
    anthropic:
      file: "internal/adapters/anthropic/anthropic_client.go"
      implements: "LLMPort"
      status: "implemented"
      method: "Chat(ctx, message) (string, error)"
      api: "POST https://api.anthropic.com/v1/messages"

    postgres:
      directory: "internal/adapters/postgres/"
      status: "implemented"
      files:
        - "postgres_client.go - Connection pool (pgxpool)"
        - "postgres_cache.go - CachePort implementation"
        - "postgres_events.go - EventPort implementation"
        - "migrations.go - Auto-migrations for chat tables"

    json_store:
      file: "internal/adapters/json_store/json_product_store.go"
      implements: "SearchPort"
      status: "stub"

    memory:
      file: "internal/adapters/memory/memory_cache.go"
      implements: "CachePort"
      status: "stub (replaced by postgres)"

  usecases:
    chat_send_message:
      file: "internal/usecases/chat_send_message.go"
      struct: "SendMessageUseCase"
      purpose: "Send message to LLM, save to DB, track events"
      status: "implemented"
      methods:
        - "Execute(ctx, req) (*SendMessageResponse, error)"
        - "WithSessionTTL(duration) *SendMessageUseCase"
      features:
        - "Session management with sliding TTL (10 min default)"
        - "Message persistence to PostgreSQL"
        - "Event tracking (chat_opened, message_sent, message_received)"
        - "Graceful handling when DB not configured"

  handlers:
    chat:
      file: "internal/handlers/handler_chat.go"
      struct: "ChatHandler"
      endpoint: "POST /api/v1/chat"
      request: "{ sessionId?: string, tenantId?: string, message: string }"
      response: "{ sessionId: string, response: string, latencyMs: int }"
      status: "implemented"

    session:
      file: "internal/handlers/handler_session.go"
      struct: "SessionHandler"
      endpoint: "GET /api/v1/session/{id}"
      response: "{ id, status, messages[], startedAt, lastActivityAt }"
      status: "implemented"

    health:
      file: "internal/handlers/handler_health.go"
      endpoints:
        - "GET /health"
        - "GET /ready"

  domain:
    atom_entity:
      file: "internal/domain/atom_entity.go"
      types: ["AtomType", "Atom"]

    widget_entity:
      file: "internal/domain/widget_entity.go"
      types: ["WidgetType", "Widget"]

    formation_entity:
      file: "internal/domain/formation_entity.go"
      types: ["FormationType", "Formation"]

    message_entity:
      file: "internal/domain/message_entity.go"
      types: ["MessageRole", "Message"]
      fields: ["ID", "SessionID", "Role", "Content", "Widgets", "Formation", "TokensUsed", "ModelUsed", "LatencyMs", "SentAt", "ReceivedAt", "Timestamp"]

    session_entity:
      file: "internal/domain/session_entity.go"
      types: ["SessionStatus", "Session"]
      fields: ["ID", "UserID", "TenantID", "Status", "Messages", "Metadata", "StartedAt", "EndedAt", "LastActivityAt", "CreatedAt", "UpdatedAt"]

    user_entity:
      file: "internal/domain/user_entity.go"
      types: ["ChatUser"]
      fields: ["ID", "ExternalID", "TenantID", "Fingerprint", "IPAddress", "UserAgent", "Metadata", "FirstSeenAt", "LastSeenAt", "CreatedAt"]

    event_entity:
      file: "internal/domain/event_entity.go"
      types: ["EventType", "ChatEvent"]
      event_types: ["chat_opened", "message_sent", "message_received", "chat_closed", "widget_clicked", "session_timeout"]

    product_entity:
      file: "internal/domain/product_entity.go"
      types: ["Product"]

    domain_errors:
      file: "internal/domain/domain_errors.go"
      errors: ["ErrSessionNotFound", "ErrProductNotFound", "ErrInvalidQuery", "ErrLLMUnavailable"]

api_endpoints:
  chat:
    method: "POST"
    path: "/api/v1/chat"
    body: "{ sessionId?: string, tenantId?: string, message: string }"
    response: "{ sessionId: string, response: string, latencyMs: int }"

  session:
    method: "GET"
    path: "/api/v1/session/{id}"
    response: "{ id, status, messages[], startedAt, lastActivityAt }"

  health:
    method: "GET"
    path: "/health"
    response: "OK"

  ready:
    method: "GET"
    path: "/ready"
    response: "OK"

database:
  provider: "Neon PostgreSQL"
  tables:
    - "chat_users - User/visitor tracking"
    - "chat_sessions - Chat sessions with status and TTL"
    - "chat_messages - Message history with metadata"
    - "chat_events - Analytics events"
  features:
    - "Auto-migrations on startup"
    - "Connection pooling (pgxpool)"
    - "SSL required for Neon"
    - "Graceful shutdown"

patterns:
  naming:
    handlers: "handler_{name}.go"
    usecases: "{domain}_{action}.go"
    adapters: "{tech}_{purpose}.go"
    domain: "{entity}_entity.go"
    ports: "{name}_port.go"
    prompts: "prompt_{name}.go"

  handler_pattern:
    - "Parse request body"
    - "Validate input"
    - "Call use case"
    - "Return JSON response"

  usecase_pattern:
    - "Struct with port dependencies"
    - "NewXxxUseCase() constructor"
    - "Execute(ctx, req) method"

run_commands:
  start: "cd project/backend && go run ./cmd/server/"
  build: "cd project/backend && go build -o server ./cmd/server/"
  test: "cd project/backend && go test ./..."

dependencies:
  - "github.com/joho/godotenv"
  - "github.com/rs/cors"
  - "github.com/jackc/pgx/v5"
  - "github.com/google/uuid"

env_vars:
  required:
    - "ANTHROPIC_API_KEY"
  optional:
    - "PORT (default: 8080)"
    - "ENVIRONMENT (default: development)"
    - "LLM_MODEL (default: claude-haiku-4-5-20251001)"
    - "LOG_LEVEL (default: info)"
    - "DATABASE_URL (PostgreSQL connection string)"

migration_status:
  description: "Hexagonal architecture with PostgreSQL persistence"
  completed:
    - "Migrate to cmd/server/main.go entry point"
    - "Implement LLMPort with Chat method"
    - "Implement Anthropic adapter"
    - "Implement SendMessageUseCase"
    - "Implement ChatHandler"
    - "Add PostgreSQL adapter with connection pooling"
    - "Implement CachePort for session/message persistence"
    - "Implement EventPort for analytics"
    - "Add session TTL (10 min sliding)"
    - "Add GET /api/v1/session/{id} endpoint"
  next_steps:
    - "Add two-agent pipeline (AnalyzeQuery + ComposeWidgets)"
    - "Implement product search"
    - "Add widget rendering"
