# Backend Implementation Expertise
# Keepstar - Go Hexagonal Architecture

overview:
  description: "Go REST API with hexagonal architecture for AI-powered chat widget"
  architecture: "Hexagonal (Ports & Adapters)"
  language: "Go 1.21+"
  port: 8080
  ai_provider: "Anthropic Claude"

project_structure:
  root: "project/backend/"

  # Текущий рабочий код (простая структура)
  active_code:
    entry: "main.go"
    files:
      - "main.go"        # HTTP server, routes, handlers
      - "anthropic.go"   # Anthropic API client
      - "gigachat.go"    # GigaChat API client (альтернатива)

  # Новая архитектура (stubs, не активна)
  hexagonal_structure:
    entry: "cmd/server/main.go"
    layers:
      domain: "internal/domain/"
      ports: "internal/ports/"
      adapters: "internal/adapters/"
      usecases: "internal/usecases/"
      handlers: "internal/handlers/"
      prompts: "internal/prompts/"
      logger: "internal/logger/"
      config: "internal/config/"
    data: "data/products.json"

layer_rules:
  description: "Направление зависимостей: handlers → usecases → ports ← adapters, всё зависит от domain"
  domain:
    imports: "Ничего из internal/"
    contains: "Сущности, типы, доменные ошибки"
  ports:
    imports: "Только domain/"
    contains: "Интерфейсы (контракты)"
  usecases:
    imports: "domain/, ports/"
    contains: "Бизнес-логика, 1 файл = 1 use case"
  adapters:
    imports: "domain/, ports/, внешние библиотеки"
    contains: "Реализации портов"
  handlers:
    imports: "Всё выше + http библиотеки"
    contains: "HTTP слой, только parse/validate/respond"
  prompts:
    imports: "domain/ (для типов)"
    contains: "LLM промпты, отдельно от логики"

core_implementation:
  # Активный код
  active:
    main:
      file: "project/backend/main.go"
      purpose: "HTTP server с chi router"
      endpoints:
        - "POST /api/chat - handleChat()"
        - "GET /health - handleHealth()"
      pattern: |
        - Load .env
        - Setup CORS
        - Register handlers
        - Start server

    anthropic:
      file: "project/backend/anthropic.go"
      purpose: "Anthropic API client"
      function: "sendToAnthropic(message string) (string, error)"
      env: "ANTHROPIC_API_KEY"

    gigachat:
      file: "project/backend/gigachat.go"
      purpose: "GigaChat API client (Сбер)"
      functions:
        - "sendToGigaChat(message string) (string, error)"
        - "getGigaChatToken() (string, error)"
      env: ["GIGACHAT_CLIENT_ID", "GIGACHAT_CLIENT_SECRET"]

  # Hexagonal stubs (не активны)
  hexagonal:
    domain:
      atom_entity:
        file: "internal/domain/atom_entity.go"
        types: ["AtomType", "Atom"]
        atom_types: ["text", "number", "price", "image", "rating", "badge", "button", "icon", "divider", "progress"]

      widget_entity:
        file: "internal/domain/widget_entity.go"
        types: ["WidgetType", "Widget"]
        widget_types: ["product_card", "product_list", "comparison_table", "image_carousel", "text_block", "quick_replies"]

      formation_entity:
        file: "internal/domain/formation_entity.go"
        types: ["FormationType", "Formation"]
        formation_types: ["grid", "list", "carousel", "single"]

      message_entity:
        file: "internal/domain/message_entity.go"
        types: ["MessageRole", "Message"]

      session_entity:
        file: "internal/domain/session_entity.go"
        types: ["Session"]

      product_entity:
        file: "internal/domain/product_entity.go"
        types: ["Product"]

      domain_errors:
        file: "internal/domain/domain_errors.go"
        errors: ["ErrSessionNotFound", "ErrProductNotFound", "ErrInvalidQuery", "ErrLLMUnavailable"]

    ports:
      llm_port:
        file: "internal/ports/llm_port.go"
        interface: "LLMPort"
        methods:
          - "AnalyzeQuery(ctx, req) - Agent 1"
          - "ComposeWidgets(ctx, req) - Agent 2"

      search_port:
        file: "internal/ports/search_port.go"
        interface: "SearchPort"
        methods:
          - "Search(ctx, params)"
          - "GetByID(ctx, id)"

      cache_port:
        file: "internal/ports/cache_port.go"
        interface: "CachePort"
        methods:
          - "GetSession(ctx, id)"
          - "SaveSession(ctx, session)"
          - "CacheProducts(ctx, sessionID, products)"
          - "GetCachedProducts(ctx, sessionID)"

    adapters:
      anthropic:
        directory: "internal/adapters/anthropic/"
        file: "anthropic_client.go"
        implements: "LLMPort"
        status: "stub"

      json_store:
        directory: "internal/adapters/json_store/"
        file: "json_product_store.go"
        implements: "SearchPort"
        status: "stub"

      memory:
        directory: "internal/adapters/memory/"
        file: "memory_cache.go"
        implements: "CachePort"
        status: "stub"

    usecases:
      chat_analyze_query:
        file: "internal/usecases/chat_analyze_query.go"
        struct: "AnalyzeQueryUseCase"
        purpose: "Agent 1: запрос → intent + search params"
        status: "stub"

      chat_compose_widgets:
        file: "internal/usecases/chat_compose_widgets.go"
        struct: "ComposeWidgetsUseCase"
        purpose: "Agent 2: данные → layout decision"
        status: "stub"

      chat_execute_search:
        file: "internal/usecases/chat_execute_search.go"
        struct: "ExecuteSearchUseCase"
        purpose: "Поиск товаров по параметрам"
        status: "stub"

    prompts:
      analyze_query:
        file: "internal/prompts/prompt_analyze_query.go"
        purpose: "Промпт для Agent 1"
        output: "intent, search_params"

      compose_widgets:
        file: "internal/prompts/prompt_compose_widgets.go"
        purpose: "Промпт для Agent 2"
        output: "widget_type, formation, columns"

api_endpoints:
  active:
    chat:
      method: "POST"
      path: "/api/chat"
      body: "{ message: string }"
      response: "{ response: string }"
      handler: "handleChat()"

    health:
      method: "GET"
      path: "/health"
      response: "OK"

patterns:
  naming:
    handlers: "handler_{name}.go"
    usecases: "{domain}_{action}.go"
    adapters: "{tech}_{purpose}.go"
    domain: "{entity}_entity.go"
    ports: "{name}_port.go"
    prompts: "prompt_{name}.go"

  handler_pattern:
    - "Parse request body"
    - "Validate input"
    - "Call use case"
    - "Return JSON response"

  usecase_pattern:
    - "Struct with port dependencies"
    - "NewXxxUseCase() constructor"
    - "Execute(ctx, req) method"

run_commands:
  start_active: "cd project/backend && go run main.go anthropic.go gigachat.go"
  start_hexagonal: "cd project/backend && go run ./cmd/server/"
  build: "cd project/backend && go build -o server ."
  test: "cd project/backend && go test ./..."

dependencies:
  - "github.com/joho/godotenv"
  - "github.com/rs/cors"

env_vars:
  required:
    - "ANTHROPIC_API_KEY"
  optional:
    - "AI_PROVIDER (anthropic|gigachat)"
    - "BACKEND_PORT (default: 8080)"
    - "GIGACHAT_CLIENT_ID"
    - "GIGACHAT_CLIENT_SECRET"

migration_status:
  description: "Старый код работает, новая архитектура в stubs"
  next_steps:
    - "Мигрировать anthropic.go → internal/adapters/anthropic/"
    - "Реализовать two-agent pipeline в usecases/"
    - "Обновить main.go для использования новой структуры"
