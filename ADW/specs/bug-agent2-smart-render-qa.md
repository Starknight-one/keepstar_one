# Bug/QA: Agent 2 Smart Render — Manual Testing Findings

## ADW ID: bug-agent2-smart-render-qa

## Контекст

Ручное тестирование после `feature-agent2-smart-render`. Сессия b1f604e6, 6 запросов подряд. Общие затраты ~$0.02 на весь круг (кэш работает). Pipeline ~4-8 секунд total.

---

## Найденные проблемы

### BUG-1. Нерелевантные товары на первом запросе

**Запрос:** "покажи кроссовки Найк"
**Ожидание:** Только кроссовки Nike
**Факт:** Показались не только кроссовки, были посторонние товары

**Вероятная причина:** Hybrid search (vector + keyword + RRF merge) недостаточно фильтрует. Возможно vector search тянет семантически близкие но нерелевантные результаты, а RRF merge не даёт достаточный вес keyword-точности.

**Область:** `tool_catalog_search.go` — RRF merge, vector search ranking, или keyword filter недостаточно строгий.

**Приоритет:** High — основной UX flow.

---

### BUG-2. Agent1 срабатывает на style-запросы

**Запрос:** "покажи крупнее с рейтингом"
**Ожидание:** Только Agent2 перерисовывает (style request, данные не меняются)
**Факт:** Agent1 вызвал `catalog_search` (видно в trace: 5839ms), данные перезагрузились

**Вероятная причина 1:** Agent1 промпт недостаточно чётко объясняет когда НЕ вызывать тулы. Правило "If user asks to CHANGE DISPLAY STYLE → DO NOT call any tool" не сработало.

**Вероятная причина 2:** В первом запросе рейтинги не были загружены (поле rating=0 в Product → nil в fieldGetter). Agent1 мог решить что нужны новые данные с рейтингами. Если так — это архитектурная проблема: нужно сразу вытаскивать ВСЕ поля master product при первом поиске.

**Подтверждение из trace:** "Покажи крупнее с рейтингом" → Agent1=catalog_search 5839ms, Agent2=render_product_preset 1275ms.

**Область:** `prompt_analyze_query.go` (Agent1 промпт), возможно `postgres_catalog.go` (неполные данные при первом поиске).

**Приоритет:** High — лишний LLM вызов + задержка + лишние деньги.

---

### BUG-3. Потеря бейджа бренда при конструировании fields[]

**Запрос:** "покажи крупнее с рейтингом"
**Ожидание:** Рейтинг добавлен, цены крупнее, бренд (бейдж Nike) остаётся
**Факт:** Рейтинг появился, цены стали price-lg, но бейдж Nike пропал. Фотки того же размера.

**Причина:** Agent2 при конструировании fields[] не включил brand в badge слот. LLM "забыл" про бренд когда конструировал новый набор полей. current_formation подсказывает что было, но LLM не обязан сохранять все поля.

**Решение (варианты):**
1. В промпте явнее: "при модификации — добавляй/убирай/меняй, не пересоздавай с нуля"
2. Логика merge на бэкенде: если fields[] передан, но какие-то required поля из пресета отсутствуют — добавить их
3. Принять как поведение: LLM решает что показывать

**Приоритет:** Medium — UX regression при style-запросах.

---

### BUG-4. Сломанный вид при "покажи в виде списка"

**Запрос:** "покажи в виде списка"
**Ожидание:** Компактный список с фотками и базовой инфой
**Факт:** Нет фоток (плейсхолдеры), какая-то лишняя инфа в карточках

**Вероятная причина:** `product_compact` пресет может не включать images в hero слот по дефолту. Или Agent2 передал fields[] с ошибкой. Или фронт не рендерит image-cover в compact mode.

**Область:** Проверить дефолтные поля `ProductCompactPreset`, проверить что Agent2 вызвал (с fields или без), проверить фронт compact layout.

**Приоритет:** Medium.

---

### BUG-5. "Покажи первый подробно" показал ВСЕ товары в detail формате

**Запрос:** "покажи первый подробно"
**Ожидание:** Один товар крупно (product_detail или product_card, single mode)
**Факт:** Все товары показались в detail формате горизонтально

**Причина:** Agent2 вызвал `render_product_preset(preset="product_detail")` без фокуса на конкретный товар. Тул отрендерил все products из state. Нет механизма "покажи только первый" — это задача фильтрации/фокуса, а не рендера.

**Решение (варианты):**
1. Agent1 должен "сфокусировать" — записать focused entity в ViewState
2. Render tool может принимать `entity_id` или `index` параметр
3. Навигация: клик по карточке уже работает (пункт 6) — может "покажи первый" должен триггерить navigation_expand

**Приоритет:** Medium — но частый user intent.

---

### BUG-6. Кнопка "назад" возвращает на самый первый вид

**Запрос:** Клик на карточку (показалась корректно) → назад
**Ожидание:** Вернуться к предыдущему виду (из пункта 5 — все товары detail)
**Факт:** Вернулся к самому первому виду (grid из пункта 1)

**Причина:** ViewStack push/pop не учитывает промежуточные рендеры Agent2. Вероятно, navigation_expand делает push, а обычные render_product_preset — нет. Stack: [initial_grid] → push(detail_single) → pop → initial_grid. Промежуточные Agent2 рендеры (крупнее, список, detail-all) не пушились в стек.

**Область:** `navigation_expand.go`, `navigation_back.go`, логика push в render tools.

**Приоритет:** High — базовая навигация сломана.

---

### BUG-7. Agent1 срабатывает слишком часто (лишние catalog_search)

**Из trace:** "Покажи крупнее с рейтингом" → catalog_search. "покажи кроссовки Найк" (второй раз) → catalog_search 3851ms. Возможно кэш стейта не используется при повторном запросе.

**Вопрос:** Считает ли 10 товаров от нового поиска, или от перезагрузки тех же? В чате каждый раз "нашлось 10 товаров" — это system message от pipeline?

**Область:** Pipeline orchestration — когда Agent1 должен быть skip-нут.

**Приоритет:** Medium.

---

### UX-8. Нельзя писать в чат пока идёт запрос

**Факт:** Input заблокирован на время pipeline execution (4-8 секунд)
**Ожидание:** Можно набирать и отправлять — следующий запрос встанет в очередь как следующий Turn

**Область:** Frontend — input lock, pipeline queue.

**Приоритет:** Medium — UX friction.

---

### UX-9. Множество сессий на странице traces — непонятно что одна сессия

**Факт:** Одна сессия (b1f604e6) показана как множество отдельных строк. Визуально не группируются.
**Ожидание:** Группировка по session_id, toggle/collapse.

**Также:** Старые сессии (из прошлых тестов) куда-то пропали.

**Область:** Frontend debug page (`/debug/traces/`), хранение сессий (in-memory? TTL?).

**Приоритет:** Low — debug tooling.

---

### ARCH-10. Неполные данные при первом поиске

**Связано с BUG-2.** При первом поиске product может прийти с rating=0, без tags, без attributes — потому что master product имеет эти данные, но join/mapping неполный.

**Ожидание:** Один поиск вытаскивает ВСЕ доступные поля master product. Agent2 видит полную картину и может конструировать fields[] без повторного поиска.

**Область:** `postgres_catalog.go` — ListProducts/VectorSearch join, product mapping.

**Приоритет:** High — блокирует корректную работу Agent2 style-запросов.

---

## Сводка по приоритетам

| # | Тип | Описание | Приоритет |
|---|-----|----------|-----------|
| 1 | BUG | Нерелевантные результаты vector search | High |
| 2 | BUG | Agent1 срабатывает на style-запросы | High |
| 3 | BUG | Потеря полей при конструировании fields[] | Medium |
| 4 | BUG | Сломанный compact/list вид | Medium |
| 5 | BUG | "покажи первый" показывает все | Medium |
| 6 | BUG | Назад возвращает на самый первый вид | High |
| 7 | BUG | Agent1 срабатывает слишком часто | Medium |
| 8 | UX | Input заблокирован во время запроса | Medium |
| 9 | UX | Traces не группируются по сессии | Low |
| 10 | ARCH | Неполные данные при первом поиске | High |

## Позитив

- fields[] конструирование работает ("только фотки и названия" — идеально)
- Клик по карточке → detail view — работает
- Кэш читается, ~$0.003-0.005 за запрос, ~$0.02 за полный круг
- Pipeline стабилен, нет крашей
- TTFB ~1.1-2.8 секунд — приемлемо

---

## TODO: Admin Catalog Import API

**Приоритет:** follow-up
**Контекст:** Сейчас каталог наполняется через hardcoded Go seed-файлы (`catalog_seed_large*.go`). Это dev-scaffolding, не масштабируется на реальных тенантов.

**Нужно:** `POST /admin/import-catalog` — принимает JSON/CSV, парсит, вставляет master_products + listings, запускает embedding + digest generation. Production-ready импорт каталога для тенантов.
