# Backlog

Бэклог задач Keepstar. Приоритизирован сверху вниз внутри каждого тира.
Формат: что, зачем, как примерно, бизнес-ценность.

---

## Tier 1 — Нужно для пилота

### ~~Stock Bulk Update API~~ DONE
`POST /admin/api/stock/bulk` — реализован. Отдельная таблица `catalog.stock`, bulk update по SKU. См. `done-catalog-evolution.md`.

### ~~Tenant Collections (Tags)~~ DONE
MVP реализован: JSONB `tags` на `products` + `services`, GIN индексы, поддержка в импорте. См. `done-catalog-evolution.md`.

### Загрузить реальный каталог пилот-клиента
**Что:** Один полный каталог реального клиента в системе.
**Зачем:** Без реальных данных нечего показывать на пилоте.
**Как:** JSON импорт через админку (уже работает). Нужно: найти клиента, получить данные, загрузить, проверить.
**Бизнес-ценность:** Прямой путь к первому контракту.

### Прокачать кейсы фронта
**Что:** Core UX должен работать гладко: поиск товаров/услуг, отображение, навигация.
**Зачем:** На пилоте клиент увидит реальный UX. Баги и кривой рендер = потеря доверия.
**Как:** Тестирование всех flow на реальном каталоге, фиксы.
**Бизнес-ценность:** Первое впечатление.

### Логирование — полное покрытие
**Что:** Структурированные логи по всему pipeline + метрики качества.
**Зачем:** Без логов в проде — слепой полёт. Нужно видеть: что ищут, что находят, где тупят, что ломается.
**Как:** Расширение текущего logger, tenant-level метрики.
**Бизнес-ценность:** Понимание "система работает хорошо или плохо" без угадывания.

### Тесты — реальная валидация, не галочки

**Что:** Переписать подход к тестированию. Текущие unit-тесты бесполезны — моки всё подделывают, тесты проходят даже когда система сломана. Нужны тесты которые *реально ломаются* когда что-то не работает.

**Проблема с текущими тестами:**
- Моки скрывают реальные баги (мок возвращает `nil, nil` — тест проходит, в проде 500)
- Тесты проверяют "вызвался ли метод" вместо "работает ли бизнес-логика"
- LLM-зависимые тесты невоспроизводимы и хрупки
- Нет edge cases: что если SKU пустой? Что если tenant не существует? Что если stock = 0?

**Как правильно:**

1. **Integration tests на реальной БД** — главный приоритет:
   - Тестовая Neon/Postgres БД (или testcontainers)
   - Полный цикл: запись → чтение → проверка данных
   - Пример: import 4 items → проверить что в `master_services` 2 строки, `stock` заполнен, tags = `["Новинки"]`
   - Пример: bulk stock update → ListProducts возвращает новый quantity (именно этот баг мы нашли при живой верификации)

2. **API smoke tests** — curl-level:
   - Поднять сервер, сделать signup → import → check products → bulk stock → verify
   - Это то что мы сделали руками при верификации catalog-evolution — надо автоматизировать
   - Bash-скрипт или Go test с `httptest.Server`

3. **Edge cases в domain logic** (без моков):
   - `processItem` с пустым SKU → error
   - `processItem` с `type: "service"` → идёт в master_services, не в master_products
   - Import с дубликатами SKU → upsert, не дубль
   - Bulk stock update с несуществующим SKU → affected = 0, не crash

4. **Contract tests для адаптеров:**
   - Адаптер реализует порт? Проверить каждый метод на реальной БД.
   - `UpsertProductListing` + `ListProducts` = round-trip test
   - `BulkUpdateStock` по SKU → `GetProduct` показывает новый stock

5. **LLM тесты — отдельно и осознанно:**
   - НЕ в CI, НЕ в каждом прогоне
   - Только для валидации промптов при их изменении
   - Фиксированный seed/temperature, snapshot expected output

**Чего НЕ делать:**
- Unit тесты с моками на каждый метод (coverage ≠ quality)
- Тесты которые "всегда зелёные" — если тест никогда не падает, он бесполезен
- Тесты на тривиальный код (геттеры, конструкторы)

**Бизнес-ценность:** При верификации catalog-evolution мы нашли 4 бага за 10 минут живого тестирования. Автоматизация этого = баги ловятся до деплоя.

---

## Tier 2 — Сразу после пилота / для масштабирования

### Crawler — сбор каталога с сайта клиента
**Что:** Утилита: URL сайта → извлечение товаров, услуг, контента → JSON → импорт.
**Зачем:** Ускорение онбординга ("мы сами всё соберём"). Даже 10% каталога = демо на данных клиента при первой встрече.
**Как:** Отдельный скрипт/сервис. Headless browser → парсинг → LLM classification → маппинг на master categories → JSON export.
**Бизнес-ценность:** Sales enabler. "Смотри, мы уже подтянули твои товары."

### Навигационная панель
**Что:** UI: история ходов (forward/back по turns), лайки/сохранение товаров, share, compare.
**Зачем:** UX polish. Пользователь хочет вернуться к понравившемуся, сравнить.
**Как:** FE: turn history в state, liked items в localStorage/session.
**Бизнес-ценность:** Engagement, конверсия.

### ~~Instant Navigation (мгновенные переходы)~~ DONE
Back < 16ms, Expand < 16ms. Formation stack (instant back) + adjacent templates (instant expand) + background sync. Phase 1: formation stack. Phase 2: adjacent formations (N formations per entity). Phase 3: adjacent templates (1 template + raw entities, ~68% payload reduction). См. `done-instant-navigation.md`, `done-adjacent-templates.md`.

### Бизнес-кейсы: триггеры и рекомендации
**Что:** Контрагент настраивает: "при поиске обуви — показывать средства ухода", "при заходе — промо баннер".
**Зачем:** Маркетинговые активности без разработки.
**Как:** Triggers в state, условия (категория, ключевые слова, время), action (показать formation).
**Бизнес-ценность:** Прямое увеличение среднего чека.

### Больше пресетов + Freestyle mode
**Что:** Новые шаблоны отображения + возможность кастомного рендера по запросу.
**Зачем:** "Покажи в виде таблицы", "Оставь только фото и цену" — пользователь хочет контроль.
**Как:** Расширение preset registry, freestyle tool improvements.
**Бизнес-ценность:** Гибкость = wow-эффект.

### Аналитика в БД тенанта
**Что:** Dashboard с метриками: что ищут, что покупают, конверсия, популярные товары.
**Зачем:** Контрагент хочет видеть ROI. "Сколько людей нашли товар через чат?"
**Как:** Агрегация event_port данных, dashboard в админке.
**Бизнес-ценность:** Обоснование платы за SaaS.

### Тогл отключения чата
**Что:** В админке: кнопка "Выключить виджет" без удаления скрипта с сайта.
**Зачем:** Контрагент хочет контроль. Выключить на время, A/B тест.
**Как:** Поле в tenant settings + проверка при init session.
**Бизнес-ценность:** Контроль и доверие клиента.

---

## Tier 3 — Масштабирование / будущее

### РФ LLM провайдер + хостинг
**Что:** Адаптер для Yandex GPT / GigaChat + деплой на РФ сервер.
**Зачем:** Anthropic/OpenAI из РФ недоступны. Для РФ клиентов нужен РФ stack.
**Как:** Новый adapter (LLMPort уже абстрагирован), проверить что pipeline не ломается. РФ PostgreSQL (Yandex Cloud / Selectel).
**Бизнес-ценность:** Доступ к РФ рынку.

### Rate Limiter
**Что:** Ограничение LLM запросов per tenant / per session.
**Зачем:** Один жадный юзер не должен положить всех.
**Как:** Token bucket per tenant, middleware.
**Бизнес-ценность:** Стабильность для всех клиентов.

### LLM-assisted Smart Import
**Что:** "Кинь что есть в любом формате — мы разберёмся". Excel, CSV, фото, голос → structured catalog.
**Зачем:** Интеграция за день, не за месяц.
**Как:** LLM разметка + автоклассификация + маппинг на master categories.
**Бизнес-ценность:** Killer feature для продаж.

### Платёжка
**Что:** Биллинг для контрагентов.
**Зачем:** Монетизация.
**Как:** Stripe/ЮKassa, подписочная модель, usage-based.
**Бизнес-ценность:** Revenue.

### Tenant Branding
**Что:** Цвета, лого, greeting, позиция виджета — из настроек тенанта.
**Зачем:** Виджет должен выглядеть как часть сайта клиента.
**Как:** Tenant settings → CSS variables в Shadow DOM.
**Бизнес-ценность:** Профессиональный вид.

### CDN + инфраструктура
**Что:** CDN для widget.js, несколько инстансов за LB.
**Зачем:** Скорость загрузки, отказоустойчивость.
**Бизнес-ценность:** SLA для клиентов.

### Видеохостинг
**Что:** Хранение и стриминг коротких видео по товарам.
**Зачем:** Видео-обзоры, 360° views, video atoms в formations.
**Как:** S3-совместимое хранилище + streaming.
**Бизнес-ценность:** Rich content = лучший engagement.

### Agent SEO / MCP endpoint
**Что:** Мультитенантный каталог как data source для внешних AI-агентов.
**Зачем:** AI-агенты (ChatGPT, Claude, etc.) ищут товары от имени пользователей. Кто первый в индексе — тот продаёт.
**Как:** MCP server / skill endpoint поверх каталога.
**Бизнес-ценность:** Новый канал продаж, "агентный SEO".

### Юр часть
**Что:** Регистрация, оферта, privacy policy, DPA для обработки данных клиентов.

### Go-to-Market
**Что:** Позиционирование, лендинг, демо-материалы.
**Зачем:** Без GTM нет клиентов.

---

*Последнее обновление: 2026-02-12*
