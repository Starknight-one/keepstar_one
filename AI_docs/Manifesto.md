## Манифест продукта

Keepstar — это SaaS B2B2C.
Его задачи делятся на 2 группы потребителей:
1. Те кто будут платить за решение — контрагенты.
2. Те кто будут использовать его больше всего — пользователи контрагентов.

---

## Что уже построено (Alpha, февраль 2026)

Рабочая система из двух проектов: Chat (виджет-чат) + Admin (панель управления).

**Chat — двуагентный pipeline:**
- Agent1 (Tool Caller): понимает запрос → вызывает tools → ищет в каталоге (hybrid: keyword + vector + RRF merge)
- Agent2 (Template Builder): решает как показать результат → выбирает mode/template/size
- Preset system: product_grid, product_card, product_detail, service_card, service_detail и др.
- Formation rendering: grid/carousel/list/single из атомов (text, number, image, rating, badge, button, icon)
- Shadow DOM виджет: один `<script>` тег → встраивается на любой сайт, изоляция стилей
- Session state: zone-based (data/template/view), delta tracking, ViewStack для навигации
- Drill-down: expand (grid → detail) и back с ViewStack
- Prompt caching: Anthropic cache_control, ~90% hit rate, ~3x экономия на токенах
- Pipeline tracing: waterfall spans, LLM metrics, cost tracking

**Admin — панель контрагента:**
- Auth: signup (создаёт tenant + user), login, JWT
- PIM: таблица товаров + detail/edit, search, category filter, pagination
- Import: JSON upload → async обработка → embeddings → catalog digest
- Settings: geo, enrichment toggle
- Widget page: embed code + copy

**Catalog — мультитенантная БД:**
- master_products (shared) + products (tenant overlay)
- pgvector embeddings (text-embedding-3-small, 384 dims)
- Catalog digest: компактная мета-схема для Agent1 prompt
- Categories: иерархические

**Deploy:**
- Railway: два сервиса (chat + admin) из одного repo
- Docker multi-stage builds
- Виджет работает кросс-доменно с auto-detect API URL

---

## Какие задачи решает

### Для контрагентов

- Помогает увеличивать конверсию в покупку, за счёт визуального ответа пользователю, достаточно гибкого
- Помогает увеличивать конверсию, через возможность добавлять бесчисленное количество контента (будут ограничения чтобы экономить на серверах)
- Убирает проблему необходимости иметь техническую команду:
  1. Раньше для добавления нового поля нужно было сверстать макет, сделать задачу для разработки, объяснить как это должно работать. Теперь достаточно загрузить данные — чат отобразит их, потому что все данные имеют ограниченный набор атомарных форматов, из которых собирается динамический дизайн
  2. Раньше нужно было делать кучу доработок в базе данных. Теперь не нужно — мультитенантная схема + импорт через админку
  3. Раньше для маркетинговых активностей нужна была команда разработки. Теперь можно настроить активности в админке и они будут показываться пользователям (в планах)
  4. Нет потребности в дизайнерах на постоянной основе. Вся информация генерируется на лету через preset system
  5. Убирается сложность установки — один `<script>` тег на действующий сайт
  6. Убирается сложность переезда — достаточно выгрузить каталог в JSON (+ в будущем голосовой ввод)
  7. Возможность перенасыщать контентом карточки товаров. Чем больше информации, тем выше вероятность покупки
  8. Аналитика в готовом формате (в планах)
  9. В будущем — доработки по запросу через мультиагентный слой

### Для пользователей контрагентов

Система навигации и просвещения. Пользователь сможет:
- Вводить текст и прикреплять картинки (на старте — текст)
- Голосовой ввод (в планах)
- Сортировки, уточнения через сужения и расширения
- Просить показывать в специфичном формате ("оставь только наименования и мощность", "сделай сравнительную таблицу")
- Задавать вопросы про продукт (обогащение голосовым/видео контентом — в планах)
- В будущем — канвас режим (приближение/отдаление, карта предпочтений)

---

## Как работает (текущая реализация)

### Двуагентный pipeline

1. **Agent1** — распознаёт запрос, обращается к каталогу через tools (catalog_search — hybrid keyword + vector), сохраняет результат в state
2. **Agent2** — получает мета-информацию о найденном (count, types, user intent), решает как скомпоновать (mode + template + size), возвращает FormationTemplate
3. **ApplyTemplate** — детерминированно собирает FormationWithData из preset + data
4. **Frontend** — получает готовый JSON, рендерит через FormationRenderer → WidgetRenderer → AtomRenderer

### UX flow

- При активации виджета экран затемняется, чат открывается справа, formations рендерятся слева/по центру
- Выход: клик вне или кнопка закрытия
- Навигация: expand (grid → detail), back (ViewStack)
- История: session сохраняется в localStorage (30min TTL)
- Навигация по turns (вперёд/назад) — в планах

### Бэкофис (Admin)

- Загрузка каталога: JSON upload → async import → auto-embeddings → digest regen
- PIM: просмотр/редактирование товаров
- Settings: geo, enrichment
- Widget: embed code для вставки на сайт

---

## Открытые архитектурные вопросы

### Мультитенантная БД и shared catalog

Текущая схема: master_products (shared) + products (tenant overlay). 10 тенантов на тест, часть с пересекающимися товарами.

Вопросы:
- Как оптимизировать shared catalog при росте (индексы, партиционирование)
- Tenant isolation vs shared benefits (shared enrichment data)
- Формат импорта для разных типов контрагентов

### РФ инфраструктура (перед пилотом)

- РФ LLM провайдер (Yandex GPT / GigaChat) — нужен LLMPort адаптер
- РФ хостинг — нужен отдельный деплой
- Проверить что логику pipeline не придётся переписывать под другого провайдера

### Масштабирование (после пилота)

- Rate limiter на LLM запросы
- CDN для widget.js
- Кэширование частых formation responses
- Несколько инстансов за load balancer
